# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

```bash
# Set up Python environment
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt

# Run the GUI (main application)
python app/main.py

# Run pipeline steps individually
python clean_data.py                 # clean data/cleaned_master.csv in-place
python generate_all_reports.py       # render one PDF per row → reports/
python validate_reports.py           # validate generated PDFs against CSV values
python send_email.py                 # send PDFs (TEST_MODE=True by default)

# Lint and test (CI)
pip install pytest ruff pyyaml PyPDF2
ruff check .
ruff format --check .
pytest
pytest tests/test_smoke.py::test_import_main_module   # single test
pytest tests/test_pipeline_sample.py                  # anonymised fixture tests

# Regenerate the anonymised test fixture
python scripts/make_sample_data.py
```

## Release workflow

Bump `version` in `pyproject.toml` and push to `main`. CI detects no git tag `v<version>` exists and fires the build matrix. Do **not** create tags manually. macOS is not a target — only Windows and Linux matter.

---

## Architecture

`app/main.py` is the canonical entry point (Tkinter GUI + PyInstaller target).

```
app/main.py
  ├── imports convert_data          → Excel/.xlsx → data/cleaned_master.csv
  ├── imports clean_data            → cleans and validates CSV in-place
  ├── imports email_tracker         → tracks per-recipient send status
  ├── imports gui_system_check      → verifies R/Quarto/TinyTeX are present at runtime
  ├── imports update_checker        → background GitHub release check
  └── imports dependency_manager    → stub (installation handled by the installer)
```

### Path resolution (frozen vs dev)

| Variable | Dev | Frozen (installed) |
|----------|-----|--------------------|
| `ROOT_DIR` / `_asset_root()` | repo root | `sys._MEIPASS` (`_internal/`) |
| `_DATA_ROOT` / `_data_root()` | repo root | `%APPDATA%\ResilienceScan` / `~/.local/share/resiliencescan` |
| `DATA_FILE` | `repo/data/cleaned_master.csv` | `APPDATA/data/cleaned_master.csv` |
| `REPORTS_DIR` | `repo/reports/` | `APPDATA/reports/` |
| `TEMPLATE` | `repo/ResilienceReport.qmd` | `APPDATA/ResilienceScan/ResilienceReport.qmd` (copied from `_internal/` by `_sync_template()`) |

---

## Pipeline flow

```
data/*.xlsx  (or .xml)
     │ convert_data.py
     ▼
data/cleaned_master.csv
     │ clean_data.py
     ▼
data/cleaned_master.csv  [validated & cleaned]
     │ generate_all_reports.py + ResilienceReport.qmd  (calls quarto render)
     ▼
reports/YYYYMMDD ResilienceScanReport (Company - Person).pdf
     │ validate_reports.py
     ▼
     │ send_email.py
     ▼
emails via Outlook COM (Windows) or SMTP fallback (Office365)
```

**Key data file:** `data/cleaned_master.csv`
**Score columns:** `up__r/c/f/v/a`, `in__r/c/f/v/a`, `do__r/c/f/v/a` — range 0–5
**PDF naming:** `YYYYMMDD ResilienceScanReport (Company Name - Firstname Lastname).pdf`

---

## Packaging strategy

**Staged installer** — the installer silently downloads and sets up all dependencies (R, Quarto, TinyTeX, R packages) during installation.

`ResilienceReport.qmd` is deeply LaTeX-dependent (TikZ, kableExtra, custom titlepage extension, custom fonts, raw `.tex` includes). The PDF engine **cannot** be switched to Typst or WeasyPrint — TinyTeX is required.

### Pinned dependency versions

| Dependency | Version | Notes |
|------------|---------|-------|
| R | latest (auto-discovered from CRAN) | Current release URL, falls back to `/old/`; fallback pin: 4.5.1 |
| Quarto | 1.6.39 | GitHub releases |
| TinyTeX | Quarto-pinned | `quarto install tinytex` |
| Python | ≥ 3.11 | bundled by PyInstaller |

### R packages

`readr`, `dplyr`, `stringr`, `tidyr`, `ggplot2`, `knitr`, `fmsb`, `scales`, `viridis`, `patchwork`, `RColorBrewer`, `gridExtra`, `png`, `lubridate`, `kableExtra`, `rmarkdown`, `jsonlite`, `ggrepel`, `cowplot`

### LaTeX packages (tlmgr names)

`pgf`, `xcolor`, `colortbl`, `booktabs`, `multirow`, `float`, `wrapfig`, `pdflscape`, `geometry`, `preprint`, `graphics`, `tabu`, `threeparttable`, `threeparttablex`, `ulem`, `makecell`, `environ`, `trimspaces`, `caption`, `hyperref`, `setspace`, `fancyhdr`, `microtype`, `lm`, `needspace`, `varwidth`, `mdwtools`, `xstring`, `tools`

**Note:** `capt-of` is NOT installed via tlmgr (tar extraction fails on fresh TinyTeX). A minimal `capt-of.sty` stub is written directly by `setup_dependencies.ps1` / `setup_linux.sh` and registered with `mktexlsr`.

---

## Working rule

**Do not start the next milestone until the current one is fully verified by its gate condition.** Each gate must pass on a clean run before any work on the next milestone begins.

---

## Milestones

### ✅ M1 — Fix CI, ship real app (v0.13.0)
### ✅ M2 — Fix paths, consolidate cleaners (v0.14.0)
### ✅ M3 — Implement data conversion (v0.15.0)
### ✅ M4 — End-to-end report generation (v0.16.0)
### ✅ M5 — Fix validation + email tracker (v0.17.0)
### ✅ M6 — Email sending (v0.18.0)
### ✅ M7 — Startup system check guard (v0.19.0)
### ✅ M8 — Complete installer: R + Quarto + TinyTeX (v0.20.5)
### ✅ M9 — Fix Windows installer: R path, LaTeX packages, capt-of (v0.20.14)
- R path: forward-slash conversion (`$R_LIB_R`) + single-quoted R package names in PS5.1
- LaTeX: corrected tlmgr package names; capt-of via stub + mktexlsr
- Startup guard: reads PATH from Windows registry + hardcoded fallbacks
- **Gate:** Fresh Windows VM — startup guard passes, all 19 R packages install, quarto render produces PDF ⏳ *pending re-test on v0.21.x build*

### ✅ M10 — Fix report generation in installed app (v0.21.0)
- File picker now accepts `.xlsx`/`.xls`; auto-copies + converts before loading
- Frozen path split: `_asset_root()` (QMD/images → `sys._MEIPASS`) vs `_data_root()` (CSV/reports/logs → APPDATA)
- Temp PDF output uses absolute `REPORTS_DIR` path (avoids writing to non-writable `_internal/`)
- **Gate:** Installed app generates correct PDF from real .xlsx — ⏳ *pending Windows test*

### ✅ M11 — Anonymised sample dataset (v0.21.0)
- `scripts/make_sample_data.py` + `tests/fixtures/sample_anonymized.xlsx` (3 fictional respondents)
- `tests/test_pipeline_sample.py` — 6 tests, all pass
- **Gate:** ✅ `pytest tests/test_pipeline_sample.py` passes on clean checkout

### ✅ M12 — End-to-end CI pipeline test (v0.21.0)
- `.github/workflows/e2e.yml` — `workflow_dispatch`, ubuntu + windows matrix
- Installs R/Quarto/TinyTeX, runs full pipeline on fixture, asserts PDFs produced
- **Gate:** ⏳ *pending first manual trigger*

### ✅ M13 — In-app update checker (v0.21.0)
- `update_checker.py` — GitHub releases API, semver compare, daemon thread
- Status bar shows clickable blue update link when newer version found
- Fixed startup crash: removed `ttk.Frame.cget("background")` (v0.21.1)
- **Gate:** ✅ App starts cleanly; update notification visible when version downgraded

### ✅ M14 — README download badges (v0.21.0)
- `Latest Release` shield badge + Downloads section with versioned links
- CI `update-readme` job patches links after each release and commits `[skip ci]`
- **Gate:** ✅ README updated by CI with correct v0.21.0 download URLs

### ✅ M15 — Fix frozen app render failures (v0.21.4 – v0.21.7)
**v0.21.4 — quarto .quarto/ PermissionDenied**
- **Root cause:** Quarto creates `.quarto/` next to the QMD. In frozen app the QMD is in `_internal/`
  (Windows: `Program Files\…\_internal\`; Linux: `/opt/…/_internal\`) — read-only → PermissionDenied.
- **Fix:** `_sync_template()` copies QMD + `img/`, `tex/`, `_extensions/`, `references.bib`,
  `QTDublinIrish.otf` from `_asset_root()` to `_data_root()` at startup (frozen only, skips if already
  up-to-date by mtime). Both render calls use `cwd=str(_DATA_ROOT)` and `selected_template = _DATA_ROOT / ...`.
- `stderr[:2000]` (was `[-500:]`) so root-cause error is visible in logs, not just the JS stack tail.
- Confirmed on Linux by reproducing `PermissionDenied: mkdir _internal/.quarto` with a read-only dir.

**v0.21.5 — TinyTeX detection for Quarto 1.4+**
- Quarto 1.4+ installs TinyTeX to `%APPDATA%\quarto\tools\tinytex\` (Windows) / `~/.local/share/quarto/tools/tinytex/` (Linux), not the legacy `TinyTeX\` location.
- Fixed in `gui_system_check._find_tlmgr()` (new candidates first), `setup_dependencies.ps1`, and `setup_linux.sh` (arch-dynamic path).

**v0.21.6 — e2e Windows TinyTeX PATH + stderr from start**
- `quarto install tinytex` only sets PATH for its own process. Added 'Add TinyTeX to PATH (Windows)' step in `e2e.yml` that writes the TinyTeX bin dir to `$GITHUB_PATH`.
- `generate_all_reports.py`: `stderr[:2000]` (was `[-1000:]`).

**v0.21.7 — R_LIBS missing from generate-single**
- `generate_single` was calling `subprocess.run` without `env=` so `R_LIBS` was never set.
- Single-report generation would fail to find R packages in the bundled `r-library/` while generate-all worked fine (it already built `gen_env`).
- Fix: build `single_env` with `R_LIBS` the same way generate-all does.

- **Why not caught earlier:** Dev mode + e2e both use system-wide R packages; bundled `r-library/` path only matters in the frozen installed app.
- **Gate:** Installed app generates correct PDF from real .xlsx on Windows ⏳ *pending Windows test*

---

## Next milestones

### ✅ M16 — Cross-platform test runner (v0.21.14)
`.github/workflows/platform.yml` — runs on every push + PR, no R/Quarto needed.

**Matrix:** `ubuntu-latest` × `windows-latest`

| Step | Ubuntu | Windows |
|---|---|---|
| `pytest` | ✅ | ✅ |
| App import smoke test | ✅ | ✅ |
| Pipeline dry run: convert → clean → verify CSV | ✅ | ✅ |
| PowerShell 5.1 syntax check (`shell: powershell`) | — | ✅ |

**Why it matters:**
- `pytest` previously only ran on Ubuntu — Windows path/encoding bugs could ship silently.
- Pipeline dry run validates the Python-only steps on both platforms on every push.
- `shell: powershell` invokes genuine PS5.1 (not PS7/pwsh); catches encoding and syntax issues
  that the existing PS7 check in `ci.yml` would miss (the v0.21.13 em-dash bug would have been
  caught here before reaching a real machine).

**Gate:** ✅ Both matrix jobs green on first run.

### ✅ M17 — e2e CI passes on both platforms (v0.21.17)
Full end-to-end pipeline (R/Quarto/TinyTeX) now reliably passes on Ubuntu + Windows.

**Key fixes applied:**
- YAML block scalar column-0 bug: printf/array join replace heredocs (run 4)
- bash pipefail + find|head: `|| true` on all pipelines (run 4)
- Windows cp1252 Unicode: `>=` not `≥`, `--` not `—` in validate_reports.py (run 4)
- GitHub API rate limit on TinyTeX: `GITHUB_TOKEN` env var (run 5)
- PS5.1 swallowing output: `shell: pwsh` (PS7) in Configure TinyTeX step (run 4)
- tlmgr symlink miss: removed `-type f` from `find`, added `which tlmgr` and `$HOME/.TinyTeX` to search (run 7)

**New tests added (89 total):**
- `test_package_sync.py` (6): R+LaTeX drift between e2e.yml and setup_dependencies.ps1
- `test_qmd_integrity.py` (6): QMD YAML, R packages in install lists, params
- `test_report_generation.py` (13): quarto command structure (mocked subprocess)
- `test_unicode_safety.py` (18): non-ASCII in print()/raise in pipeline scripts
- `test_workflow_yaml.py` (16): YAML validity, structure, column-0 bug detection
- `test_installer_sanity.py` (16): assets, version, PS1 consistency

**Gate:** ✅ e2e.yml run 7 — both Ubuntu and Windows generate PDF artifacts.

---

## Next milestones

*Windows install test: v0.21.16 release on a fresh Windows machine. Report any errors found.*
