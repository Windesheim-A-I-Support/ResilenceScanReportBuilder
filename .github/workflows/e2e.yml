name: End-to-End Pipeline Test

# Runs the full convert → clean → generate → validate pipeline against the
# anonymised sample fixture (tests/fixtures/sample_anonymized.xlsx).
# Triggered manually so it doesn't slow down every push.
# Promote to push/main once it reliably passes on both platforms.

on:
  workflow_dispatch:
  # Uncomment to run automatically on release tags once stable:
  # push:
  #   tags: ["v*"]

jobs:
  e2e:
    name: E2E (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            r_url: "https://cloud.r-project.org/bin/linux/ubuntu"
            quarto_url: "https://github.com/quarto-dev/quarto-cli/releases/download/v1.6.39/quarto-1.6.39-linux-amd64.deb"
          - os: windows-latest
            quarto_url: "https://github.com/quarto-dev/quarto-cli/releases/download/v1.6.39/quarto-1.6.39-win.msi"

    steps:
      - uses: actions/checkout@v4

      # ── Python ───────────────────────────────────────────────────────────────
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: pip

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest ruff pyyaml

      - name: Install system libraries (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            python3-tk tk-dev libcurl4-openssl-dev libssl-dev libxml2-dev \
            libfontconfig1-dev libharfbuzz-dev libfribidi-dev \
            libfreetype6-dev libpng-dev libtiff5-dev libjpeg-dev

      # ── R ────────────────────────────────────────────────────────────────────
      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: "release"

      - name: Install R packages
        shell: Rscript {0}
        run: |
          pkgs <- c(
            "readr", "dplyr", "stringr", "tidyr", "ggplot2", "knitr",
            "fmsb", "scales", "viridis", "patchwork", "RColorBrewer",
            "gridExtra", "png", "lubridate", "kableExtra", "rmarkdown",
            "jsonlite", "ggrepel", "cowplot"
          )
          install.packages(pkgs, repos = "https://cloud.r-project.org", quiet = TRUE)

      # ── Quarto ───────────────────────────────────────────────────────────────
      - name: Install Quarto (Linux)
        if: runner.os == 'Linux'
        run: |
          curl -fsSL "${{ matrix.quarto_url }}" -o quarto.deb
          sudo dpkg -i quarto.deb
          quarto --version

      - name: Install Quarto (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          Invoke-WebRequest "${{ matrix.quarto_url }}" -OutFile quarto.msi -UseBasicParsing
          Start-Process msiexec -ArgumentList "/i","quarto.msi","/qn","/norestart" -Wait
          # Persist Quarto bin dir to GITHUB_PATH so ALL subsequent steps can
          # find quarto.  Setting $env:PATH alone only affects this one step.
          $quartoDir = "C:\Program Files\Quarto\bin"
          if (Test-Path $quartoDir) {
            Add-Content $env:GITHUB_PATH $quartoDir
            $env:PATH = "$quartoDir;$env:PATH"
          }
          quarto --version

      # ── TinyTeX ──────────────────────────────────────────────────────────────
      # GITHUB_TOKEN is passed so quarto can make authenticated GitHub API calls
      # when fetching the latest rstudio/tinytex-releases release.  Without it
      # the anonymous rate limit is often exhausted on shared CI runners, causing
      # "Unable to determine latest release" errors.
      - name: Install TinyTeX
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: quarto install tinytex --no-prompt

      # Single combined step per platform: find tlmgr via full path, install
      # LaTeX packages, and write the capt-of stub -- no reliance on PATH
      # being updated between steps.
      - name: Configure TinyTeX + install LaTeX packages (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          # quarto install tinytex does not add tlmgr to PATH.
          # Use || true on every find|head pipeline: with -e -o pipefail, find
          # returning non-zero (directory missing) would kill the script silently.
          TLMGR=$(find "$HOME/.local/share/quarto" -name tlmgr -type f 2>/dev/null | head -1 || true)
          if [[ -z "$TLMGR" ]]; then
            TLMGR=$(find "$HOME" -maxdepth 10 -name tlmgr -type f 2>/dev/null | head -1 || true)
          fi
          if [[ -z "$TLMGR" ]]; then
            echo "::error::tlmgr not found anywhere under $HOME"
            exit 1
          fi
          echo "tlmgr: $TLMGR"
          TLMGR_DIR=$(dirname "$TLMGR")
          # Persist bin dir for subsequent steps (quarto render may need tlmgr)
          echo "$TLMGR_DIR" >> "$GITHUB_PATH"

          "$TLMGR" install \
            pgf xcolor colortbl booktabs multirow float wrapfig pdflscape \
            geometry preprint graphics tabu threeparttable threeparttablex \
            ulem makecell environ trimspaces caption hyperref setspace \
            fancyhdr microtype lm needspace varwidth mdwtools xstring tools

          # Write capt-of stub (tlmgr tar extraction fails on fresh TinyTeX)
          # printf avoids heredoc lines at column-0 which break YAML parsing.
          TEXMF=$("$TLMGR_DIR/kpsewhich" -var-value TEXMFHOME 2>/dev/null || echo "$HOME/texmf")
          DIR="$TEXMF/tex/latex/capt-of"
          mkdir -p "$DIR"
          printf '%s\n' \
            '\NeedsTeXFormat{LaTeX2e}' \
            '\ProvidesPackage{capt-of}[2011/08/12 v0.2 non-floating captions (stub)]' \
            '\newcommand\captionof[2][\@captype]{\def\@captype{#1}\caption{#2}}' \
            > "$DIR/capt-of.sty"
          "$TLMGR_DIR/mktexlsr" "$TEXMF" 2>/dev/null || true
          echo "capt-of stub written to $DIR"

      # Use shell: pwsh (PowerShell 7) -- NOT shell: powershell (PS5.1).
      # PS5.1 dot-sources the script body and swallows Write-Host output and
      # exit codes, making it impossible to debug or detect failures reliably.
      # PS7 outputs synchronously and propagates exit codes correctly.
      - name: Configure TinyTeX + install LaTeX packages (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Search USERPROFILE, APPDATA, and LOCALAPPDATA for tlmgr.bat.
          # quarto install tinytex uses a non-standard per-user location.
          $roots = @($env:USERPROFILE, $env:APPDATA, $env:LOCALAPPDATA) |
                   Where-Object { $_ -and (Test-Path $_) } |
                   Select-Object -Unique
          Write-Host "Roots to search: $($roots -join ', ')"

          $tlmgr = $null
          foreach ($root in $roots) {
            Write-Host "  Scanning $root ..."
            $hit = Get-ChildItem -Path $root -Filter "tlmgr.bat" `
                       -Recurse -ErrorAction SilentlyContinue |
                   Select-Object -First 1
            if ($hit) {
              $tlmgr = $hit.FullName
              Write-Host "Found: $tlmgr"
              break
            }
          }
          if (-not $tlmgr) {
            Write-Host "::error::tlmgr.bat not found in USERPROFILE/APPDATA/LOCALAPPDATA"
            exit 1
          }

          $tlmgrDir = Split-Path $tlmgr -Parent
          # Persist bin dir for subsequent steps
          Add-Content $env:GITHUB_PATH $tlmgrDir
          Write-Host "Added to GITHUB_PATH: $tlmgrDir"

          # PS7 can invoke .bat files directly (routes through cmd.exe automatically)
          $pkgs = @(
            "pgf","xcolor","colortbl","booktabs","multirow","float","wrapfig","pdflscape",
            "geometry","preprint","graphics","tabu","threeparttable","threeparttablex",
            "ulem","makecell","environ","trimspaces","caption","hyperref","setspace",
            "fancyhdr","microtype","lm","needspace","varwidth","mdwtools","xstring","tools"
          )
          & $tlmgr install @pkgs
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

          # Write capt-of stub (tlmgr tar extraction fails on fresh TinyTeX)
          # Use -join instead of @'...'@ here-strings to avoid YAML column-0 issues.
          $kpsewhich = Join-Path $tlmgrDir "kpsewhich.exe"
          $texmfHome = if (Test-Path $kpsewhich) {
            (& $kpsewhich -var-value TEXMFHOME 2>$null) | Select-Object -First 1 | ForEach-Object { $_.Trim() }
          } else { $null }
          if (-not $texmfHome) { $texmfHome = "$env:USERPROFILE\texmf" }
          Write-Host "TEXMFHOME: $texmfHome"

          $captOfDir = "$texmfHome\tex\latex\capt-of"
          New-Item -ItemType Directory -Path $captOfDir -Force | Out-Null
          $stub = @(
            '\NeedsTeXFormat{LaTeX2e}',
            '\ProvidesPackage{capt-of}[2011/08/12 v0.2 non-floating captions (stub)]',
            '\newcommand\captionof[2][\@captype]{\def\@captype{#1}\caption{#2}}'
          ) -join "`n"
          Set-Content "$captOfDir\capt-of.sty" $stub -Encoding UTF8

          $mktexlsr = Join-Path $tlmgrDir "mktexlsr.exe"
          if (Test-Path $mktexlsr) { & $mktexlsr $texmfHome } else { Write-Host "mktexlsr not found, skipping" }
          Write-Host "capt-of stub written to $captOfDir"

      # ── Pipeline run ─────────────────────────────────────────────────────────
      - name: Prepare data directory with fixture
        shell: bash
        run: |
          mkdir -p data
          cp tests/fixtures/sample_anonymized.xlsx data/

      - name: Convert Excel → CSV
        run: python convert_data.py

      - name: Clean CSV
        run: python clean_data.py

      - name: Generate reports
        shell: bash
        run: |
          mkdir -p reports
          python generate_all_reports.py

      - name: Count generated PDFs
        shell: bash
        run: |
          COUNT=$(find reports -name "*.pdf" | wc -l)
          echo "PDFs generated: $COUNT"
          if [ "$COUNT" -lt 1 ]; then
            echo "ERROR: No PDFs were generated"
            exit 1
          fi

      - name: Validate reports
        run: python validate_reports.py

      - name: Upload PDFs as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-reports-${{ matrix.os }}
          path: reports/*.pdf
          if-no-files-found: warn
